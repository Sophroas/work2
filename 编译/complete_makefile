# å®Œæ•´çš„ToyCç¼–è¯‘å™¨Makefile

CXX = g++
CXXFLAGS = -std=c++20 -Wall -Wextra -O2
INCLUDES = -Isrc -I.

# æ ¸å¿ƒæºæ–‡ä»¶
CORE_SOURCES = src/ast.cpp \
               src/symbol_table.cpp \
               src/semantic_analyzer.cpp \
               src/code_generator.cpp \
               src/optimizer.cpp \
               src/manual_lexer.cpp \
               src/manual_parser.cpp

# ç›®æ ‡æ–‡ä»¶
CORE_OBJECTS = $(CORE_SOURCES:.cpp=.o)

# ç¼–è¯‘å™¨ç¨‹åº
COMPILER_TARGET = toyc_compiler
TEST_TARGET = test_compiler
BATCH_TEST_TARGET = batch_test

.PHONY: all test batch_test clean help debug

all: $(COMPILER_TARGET)

# ä¸»ç¼–è¯‘å™¨
$(COMPILER_TARGET): src/toyc_main.cpp $(CORE_OBJECTS)
	$(CXX) $(CXXFLAGS) $(INCLUDES) $< $(CORE_OBJECTS) -o $@

# æµ‹è¯•ç¨‹åº
$(TEST_TARGET): comprehensive_test.cpp $(CORE_OBJECTS)
	$(CXX) $(CXXFLAGS) $(INCLUDES) $< $(CORE_OBJECTS) -o $@

# ç¼–è¯‘å¯¹è±¡æ–‡ä»¶
%.o: %.cpp
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# è°ƒè¯•ç‰ˆæœ¬
debug: CXXFLAGS += -g -DDEBUG_INPUT -DDEBUG_TOKENS -DDEBUG_AST -DDEBUG_SEMANTIC -DDEBUG_OPTIMIZATION
debug: $(COMPILER_TARGET)

# æµ‹è¯•å•ä¸ªç”¨ä¾‹
test: $(COMPILER_TARGET)
	@echo "=== æµ‹è¯•æœ€å°ç”¨ä¾‹ ==="
	./$(COMPILER_TARGET) < 01_minimal.tc > 01_minimal.s
	@if [ $$? -eq 0 ]; then \
		echo "âœ“ 01_minimal.tc ç¼–è¯‘æˆåŠŸ"; \
		echo "ç”Ÿæˆçš„æ±‡ç¼–ä»£ç :"; \
		head -20 01_minimal.s; \
	else \
		echo "âœ— 01_minimal.tc ç¼–è¯‘å¤±è´¥"; \
	fi

# æ‰¹é‡æµ‹è¯•æ‰€æœ‰ç”¨ä¾‹
batch_test: $(COMPILER_TARGET)
	@echo "=== ToyCç¼–è¯‘å™¨æ‰¹é‡æµ‹è¯• ==="
	@total=0; passed=0; \
	for tc_file in *.tc; do \
		if [ -f "$$tc_file" ]; then \
			total=$$((total + 1)); \
			echo -n "æµ‹è¯• $$tc_file: "; \
			if ./$(COMPILER_TARGET) < "$$tc_file" > "$${tc_file%.tc}.s" 2>/dev/null; then \
				echo "âœ“ ç¼–è¯‘æˆåŠŸ"; \
				passed=$$((passed + 1)); \
			else \
				echo "âœ— ç¼–è¯‘å¤±è´¥"; \
			fi; \
		fi; \
	done; \
	echo "=== æµ‹è¯•ç»“æœ ==="; \
	echo "æ€»è®¡: $$total ä¸ªæµ‹è¯•ç”¨ä¾‹"; \
	echo "é€šè¿‡: $$passed ä¸ª"; \
	echo "å¤±è´¥: $$((total - passed)) ä¸ª"; \
	if [ $$passed -eq $$total ]; then \
		echo "ğŸ‰ æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡ï¼"; \
	else \
		echo "âš ï¸  éƒ¨åˆ†æµ‹è¯•ç”¨ä¾‹å¤±è´¥"; \
	fi

# è¯¦ç»†æµ‹è¯•ï¼ˆæ˜¾ç¤ºè¯¦ç»†è¾“å‡ºï¼‰
verbose_test: $(COMPILER_TARGET)
	@echo "=== è¯¦ç»†æµ‹è¯•æ¨¡å¼ ==="
	@for tc_file in *.tc; do \
		if [ -f "$$tc_file" ]; then \
			echo "=========================================="; \
			echo "æµ‹è¯•: $$tc_file"; \
			echo "æºä»£ç :"; \
			cat "$$tc_file"; \
			echo ""; \
			echo "ç¼–è¯‘ç»“æœ:"; \
			if ./$(COMPILER_TARGET) < "$$tc_file" > "$${tc_file%.tc}.s" 2>&1; then \
				echo "âœ“ ç¼–è¯‘æˆåŠŸ"; \
				echo "ç”Ÿæˆçš„æ±‡ç¼–ä»£ç :"; \
				cat "$${tc_file%.tc}.s"; \
			else \
				echo "âœ— ç¼–è¯‘å¤±è´¥"; \
			fi; \
			echo ""; \
		fi; \
	done

# æ¸…ç†
clean:
	rm -f $(CORE_OBJECTS) $(COMPILER_TARGET) $(TEST_TARGET) *.s

# å¸®åŠ©
help:
	@echo "ToyCç¼–è¯‘å™¨æ„å»ºç³»ç»Ÿ"
	@echo ""
	@echo "ç›®æ ‡:"
	@echo "  all         - æ„å»ºç¼–è¯‘å™¨ (é»˜è®¤)"
	@echo "  test        - æµ‹è¯•å•ä¸ªç”¨ä¾‹"
	@echo "  batch_test  - æ‰¹é‡æµ‹è¯•æ‰€æœ‰ç”¨ä¾‹"
	@echo "  verbose_test- è¯¦ç»†æµ‹è¯•æ¨¡å¼"
	@echo "  debug       - æ„å»ºè°ƒè¯•ç‰ˆæœ¬"
	@echo "  clean       - æ¸…ç†æ„å»ºæ–‡ä»¶"
	@echo "  help        - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
	@echo ""
	@echo "ä½¿ç”¨æ–¹å¼:"
	@echo "  make"
	@echo "  ./toyc_compiler < input.tc > output.s"
	@echo "  ./toyc_compiler -opt < input.tc > output.s"
	@echo "  make batch_test"

# ä¾èµ–å…³ç³»
src/ast.o: src/ast.cpp src/ast.h
src/symbol_table.o: src/symbol_table.cpp src/symbol_table.h
src/semantic_analyzer.o: src/semantic_analyzer.cpp src/semantic_analyzer.h src/ast.h src/symbol_table.h
src/code_generator.o: src/code_generator.cpp src/code_generator.h src/ast.h src/symbol_table.h
src/optimizer.o: src/optimizer.cpp src/optimizer.h src/ast.h
src/manual_lexer.o: src/manual_lexer.cpp src/manual_lexer.h
src/manual_parser.o: src/manual_parser.cpp src/manual_parser.h src/manual_lexer.h src/ast.h
src/toyc_main.o: src/toyc_main.cpp src/manual_lexer.h src/manual_parser.h src/semantic_analyzer.h src/code_generator.h src/optimizer.h
